#!/usr/bin/env ruby

require 'pathname'
require 'thor'

class TMBundle < Thor
  desc 'edit PARTIAL_NAME', 'Edit an installed bundle (name will be matched against PARTIAL_NAME)'
  def edit partial_name
    matches = installed_bundles.select do |bundle|
      bundle.name =~ /^#{partial_name}/i
    end

    if matches.size > 1
      puts "please be more specific:"
      matches.each_with_index {|m,i| puts " #{i+1}) #{m.name}"}
      return false
    end

    if matches.empty?
      puts "nothing found"
      return false
    end

    bundle = matches.first
    mate bundle.path
  end

  private

  def installed_bundles
    @installed_bundles ||= begin
      bundles_dir = Pathname('~/Library/Application Support/Avian/Bundles').expand_path
      Dir[bundles_dir.join('*').to_s].map {|path| Bundle.new(path)}
    end
  end

  class Bundle < Struct.new(:path)
    def name
      @name ||= File.basename(path)
    end
  end

  def mate *args
    exec 'mate', *args
  end
end

TMBundle.start
