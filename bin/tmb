#!/usr/bin/env ruby

require 'pathname'

class TMBundle < Thor
  desc 'edit a bundle'
  def edit partial_name
    matches = installed_bundles.select do |bundle|
      bundle.name =~ /^#{partial_name}/i
    end

    if matches.size > 1
      puts "please be more specific:"
      matches.each_with_index {|m,i| puts " #{i+1}) #{m}"}
      return false
    end

    if matches.empty?
      puts "nothing found"
      return false
    end

    mate matches.first.path
  end

  private

  def installed_bundles
    @installed_bundles ||= begin
      bundles_dir = Pathname('~/Library/Application Support/Avian/Bundles').expand_path
      Dir[bundles_dir.join('*').to_s].map {|path| Bundle.new(path)}
    end
  end

  class Bundle < Struct.new(:path)
    def name
      @name ||= File.basename(path)
    end
  end

  def mate *args
    command = ['mate']

    if args.first
      filename, line = args.first.split(':')

      command << filename
      command += ['-l', line] if line
    end
    command << '.' if command.size == 1
    exec *command
  end
end

